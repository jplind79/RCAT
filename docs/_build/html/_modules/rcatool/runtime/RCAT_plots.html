<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rcatool.runtime.RCAT_plots &mdash; RCAT 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=2709fde1"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            RCAT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../howto.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API-reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release.html">Release notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">RCAT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">rcatool.runtime.RCAT_plots</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for rcatool.runtime.RCAT_plots</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; Module script for plotting &quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xa</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">rcatool.plot.plots</span> <span class="k">as</span> <span class="nn">rpl</span>
<span class="kn">from</span> <span class="nn">rcatool.utils.polygons</span> <span class="kn">import</span> <span class="n">mask_region</span>
<span class="kn">from</span> <span class="nn">rcatool.stats.arithmetics</span> <span class="kn">import</span> <span class="n">run_mean</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="c1"># Colors</span>
<span class="n">set1</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="o">.</span><span class="n">colors</span>
<span class="n">set1_m</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">triplet</span><span class="p">]</span> <span class="k">for</span> <span class="n">triplet</span> <span class="ow">in</span> <span class="n">set1</span><span class="p">]</span>
<span class="n">rel_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#</span><span class="si">{:02x}{:02x}{:02x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">set1_m</span><span class="p">]</span>
<span class="n">abs_colors</span> <span class="o">=</span> <span class="n">rel_colors</span><span class="p">[:]</span>
<span class="n">abs_colors</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="plot_main">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.plot_main">[docs]</a>
<span class="k">def</span> <span class="nf">plot_main</span><span class="p">(</span><span class="n">pltdict</span><span class="p">,</span> <span class="n">statistic</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function that controls the plotting procedure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pdict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">pltdict</span><span class="p">)</span>
    <span class="n">models</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">]</span>
    <span class="n">nmod</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
    <span class="n">ref_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;observation&#39;</span><span class="p">]</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
    <span class="n">tres</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;time res&#39;</span><span class="p">]</span>
    <span class="n">tstat</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;stat method&#39;</span><span class="p">]</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
    <span class="n">time_suffix_dd</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;time suffix dict&#39;</span><span class="p">]</span>
    <span class="n">regions</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">]</span>
    <span class="n">img_dir</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;img dir&#39;</span><span class="p">]</span>

    <span class="n">grid_coords</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;grid coords&#39;</span><span class="p">]</span>
    <span class="n">moments_plot_conf</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;moments plot config&#39;</span><span class="p">]</span>
    <span class="n">map_projection</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;map projection&#39;</span><span class="p">]</span>
    <span class="n">map_config</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;map config&#39;</span><span class="p">]</span>
    <span class="n">map_extent</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;map extent&#39;</span><span class="p">]</span>
    <span class="n">map_gridlines</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;map gridlines&#39;</span><span class="p">]</span>
    <span class="n">map_axes_conf</span> <span class="o">=</span> <span class="n">_map_grid_setup</span><span class="p">(</span>
        <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;map grid setup&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">map_domain</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;map domain&#39;</span><span class="p">]</span>
    <span class="n">map_plot_conf</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;map plot kwargs&#39;</span><span class="p">]</span>

    <span class="n">line_grid</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;line grid setup&#39;</span><span class="p">]</span>
    <span class="n">line_sets</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;line kwargs&#39;</span><span class="p">]</span>

    <span class="n">fm_list</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;mod files&#39;</span><span class="p">][</span><span class="n">statistic</span><span class="p">]</span>
    <span class="n">fo_list</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;obs files&#39;</span><span class="p">][</span><span class="n">statistic</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fm_listr</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;mod reg files&#39;</span><span class="p">][</span><span class="n">statistic</span><span class="p">]</span>
        <span class="n">fo_listr</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;obs reg files&#39;</span><span class="p">][</span><span class="n">statistic</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fm_listr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fo_listr</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_plots</span><span class="p">(</span><span class="n">statistic</span><span class="p">)(</span>
        <span class="n">fm_list</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">,</span> <span class="n">fm_listr</span><span class="p">,</span> <span class="n">fo_listr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span>
        <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span> <span class="n">grid_coords</span><span class="p">,</span>
        <span class="n">moments_plot_conf</span><span class="p">,</span> <span class="n">map_domain</span><span class="p">,</span> <span class="n">map_projection</span><span class="p">,</span> <span class="n">map_config</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span>
        <span class="n">map_gridlines</span><span class="p">,</span> <span class="n">map_axes_conf</span><span class="p">,</span> <span class="n">map_plot_conf</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">,</span> <span class="n">line_sets</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_map_grid_setup</span><span class="p">(</span><span class="n">map_grid_set</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Potentially modify map grid settings for map plots</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;cbar_mode&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">map_grid_set</span><span class="p">:</span>
        <span class="n">map_grid_set</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cbar_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;each&#39;</span><span class="p">})</span>
        <span class="n">map_grid_set</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cbar_pad&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">})</span>
    <span class="k">if</span> <span class="s1">&#39;axes_pad&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">map_grid_set</span><span class="p">:</span>
        <span class="n">map_grid_set</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;axes_pad&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">map_grid_set</span>


<span class="k">def</span> <span class="nf">_plots</span><span class="p">(</span><span class="n">stat</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;seasonal cycle&#39;</span><span class="p">:</span> <span class="n">map_season</span><span class="p">,</span>
        <span class="s1">&#39;annual cycle&#39;</span><span class="p">:</span> <span class="n">map_ann_cycle</span><span class="p">,</span>
        <span class="s1">&#39;percentile&#39;</span><span class="p">:</span> <span class="n">map_pctls</span><span class="p">,</span>
        <span class="s1">&#39;diurnal cycle&#39;</span><span class="p">:</span> <span class="n">map_diurnal_cycle</span><span class="p">,</span>
        <span class="s1">&#39;pdf&#39;</span><span class="p">:</span> <span class="n">pdf_plot</span><span class="p">,</span>
        <span class="s1">&#39;moments&#39;</span><span class="p">:</span> <span class="n">moments_plot</span><span class="p">,</span>
        <span class="s1">&#39;asop&#39;</span><span class="p">:</span> <span class="n">map_asop</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="n">stat</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_round_down</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span> <span class="o">/</span> <span class="n">multiplier</span>


<span class="k">def</span> <span class="nf">_round_up</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span> <span class="o">/</span> <span class="n">multiplier</span>


<span class="k">def</span> <span class="nf">_mask_data</span><span class="p">(</span><span class="n">ds_in</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="n">mdata</span> <span class="o">=</span> <span class="n">ds_in</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">ds_out</span> <span class="o">=</span> <span class="n">mdata</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span>
    <span class="n">ds_out</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds_in</span><span class="o">.</span><span class="n">attrs</span>
    <span class="k">return</span> <span class="n">ds_out</span>


<div class="viewcode-block" id="round_to_sign_digits">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.round_to_sign_digits">[docs]</a>
<span class="k">def</span> <span class="nf">round_to_sign_digits</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sig</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="get_clevs">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.get_clevs">[docs]</a>
<span class="k">def</span> <span class="nf">get_clevs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">centered</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">skew</span>
    <span class="k">if</span> <span class="n">centered</span><span class="p">:</span>
        <span class="n">abs_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">98</span><span class="p">)</span>
        <span class="n">abs_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">skew</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">())])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">abs_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
            <span class="n">abs_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># abs_max = np.nanmax(data)</span>
            <span class="n">abs_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">97</span><span class="p">)</span>
            <span class="n">abs_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">centered</span><span class="p">:</span>
        <span class="n">abs_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">abs_max</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">abs_min</span><span class="p">))</span>
        <span class="n">abs_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">abs_max</span>
    <span class="k">if</span> <span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">abs_max</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">abs_min</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)):</span>
        <span class="n">nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">abs_max</span><span class="p">))))</span>
        <span class="n">round_max</span> <span class="o">=</span> <span class="n">_round_up</span><span class="p">(</span><span class="n">abs_max</span><span class="p">,</span> <span class="n">nz</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">abs_min</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">round_min</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">abs_min</span><span class="p">))))</span>
            <span class="n">round_min</span> <span class="o">=</span> <span class="n">_round_down</span><span class="p">(</span><span class="n">abs_min</span><span class="p">,</span> <span class="n">nz</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">((</span><span class="n">abs_max</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">abs_min</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)):</span>
        <span class="n">round_max</span> <span class="o">=</span> <span class="n">_round_up</span><span class="p">(</span><span class="n">abs_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">round_min</span> <span class="o">=</span> <span class="n">_round_down</span><span class="p">(</span><span class="n">abs_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">round_max</span> <span class="o">=</span> <span class="n">_round_up</span><span class="p">(</span><span class="n">abs_max</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">round_min</span> <span class="o">=</span> <span class="n">_round_down</span><span class="p">(</span><span class="n">abs_min</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">diff</span> <span class="o">=</span> <span class="n">round_max</span> <span class="o">-</span> <span class="n">round_min</span>
    <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># nsteps = 15</span>
        <span class="c1"># nz = np.floor(np.abs(np.log10(np.abs(diff))))</span>
        <span class="c1"># nz = round(diff, -int(np.floor(np.log10(abs(diff)))))</span>
        <span class="c1"># step = _round_down(diff/nsteps, nz+2)</span>
        <span class="n">_clevs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">round_min</span><span class="p">,</span> <span class="n">round_max</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
        <span class="n">clevs</span> <span class="o">=</span> <span class="p">[</span><span class="n">round_to_sign_digits</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_clevs</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mf">.5</span>
        <span class="k">elif</span> <span class="mi">10</span> <span class="o">&lt;=</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="mi">25</span> <span class="o">&lt;=</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mf">2.5</span>
        <span class="k">elif</span> <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">150</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">elif</span> <span class="mi">150</span> <span class="o">&lt;=</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">clevs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">round_min</span><span class="p">,</span> <span class="n">round_max</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clevs</span></div>



<span class="k">def</span> <span class="nf">_get_colorbar_label_formatting</span><span class="p">(</span><span class="n">clevs</span><span class="p">):</span>
    <span class="n">decimals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">clevs</span><span class="p">]</span>
    <span class="n">number_of_decimals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">decimals</span><span class="p">]</span>
    <span class="n">max_decimals</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">number_of_decimals</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">max_decimals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;{:.&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">max_decimals</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;f}&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">max_decimals</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">decimals</span><span class="p">]):</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.0f}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.1f}</span><span class="s1">&#39;</span>

    <span class="k">return</span> <span class="n">fmt</span>


<div class="viewcode-block" id="map_season">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.map_season">[docs]</a>
<span class="k">def</span> <span class="nf">map_season</span><span class="p">(</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">,</span> <span class="n">fm_listr</span><span class="p">,</span> <span class="n">fo_listr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span>
               <span class="n">obs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span>
               <span class="n">grid_coords</span><span class="p">,</span> <span class="n">moments_plot_conf</span><span class="p">,</span> <span class="n">map_domain</span><span class="p">,</span> <span class="n">map_projection</span><span class="p">,</span>
               <span class="n">map_config</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span> <span class="n">map_gridlines</span><span class="p">,</span> <span class="n">map_axes_conf</span><span class="p">,</span>
               <span class="n">map_plot_conf</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">,</span> <span class="n">line_sets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting seasonal mean map plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ref_mnme</span> <span class="o">=</span> <span class="n">ref_model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">othr_mod</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">othr_mod</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_model</span><span class="p">)</span>

    <span class="c1"># Obs data list</span>
    <span class="n">obslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">obs</span>

    <span class="c1"># Map settings</span>
    <span class="n">target_grid_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">tgname</span> <span class="o">=</span> <span class="n">target_grid_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">domain_model</span> <span class="o">=</span> <span class="n">map_domain</span> <span class="k">if</span> <span class="n">map_domain</span> <span class="k">else</span> <span class="n">ref_model</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;meta data&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="n">domain_model</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_region</span><span class="p">(</span>
        <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">],</span>
        <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">],</span> <span class="n">domain</span><span class="p">)</span>

    <span class="c1"># Data</span>
    <span class="n">fmod</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">)}</span>
    <span class="n">fmod_msk</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">_mask_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">fmod</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">if</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obslbl</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">)</span>
        <span class="n">ref_obs</span> <span class="o">=</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obslist</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">)}</span>
        <span class="n">fobs_msk</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">_mask_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">fobs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">dlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> <span class="o">+</span>\
                <span class="p">[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                 <span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dlist</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fobs_msk</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                      <span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                      <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
            <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
                <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span>
            <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
                <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> <span class="o">+</span>\
                <span class="p">[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                 <span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
        <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_mnme</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
            <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_mnme</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span>

    <span class="c1"># figure settings</span>
    <span class="n">figshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">figshape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>

    <span class="n">tsuffix_ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">time_suffix_dd</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">tsuffix_ll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">tsuffix_fname</span> <span class="o">=</span> <span class="s2">&quot;_vs_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tsuffix_ll</span><span class="p">))</span>
    <span class="n">thr</span> <span class="o">=</span> <span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
        <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">thr</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
        <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">] | Threshold: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">thr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}{}</span><span class="s1">_map_seasonal_cycle_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}{}</span><span class="s1">_map_seasonal_cycle_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">_map_seasonal_cycle_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">_map_seasonal_cycle_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;pr&#39;</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">YlGnBu</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">BrBG</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span><span class="o">*</span><span class="mi">4</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral_r</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu_r</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span><span class="o">*</span><span class="mi">4</span>

    <span class="n">clevs_abs</span> <span class="o">=</span> <span class="n">get_clevs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]),</span> <span class="n">centered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">clevs_rel</span> <span class="o">=</span> <span class="n">get_clevs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">]),</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fmt_abs</span> <span class="o">=</span> <span class="n">_get_colorbar_label_formatting</span><span class="p">(</span><span class="n">clevs_abs</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">fmt_rel</span> <span class="o">=</span> <span class="n">_get_colorbar_label_formatting</span><span class="p">(</span><span class="n">clevs_rel</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">clevs</span> <span class="o">=</span> <span class="p">[</span><span class="n">clevs_abs</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="n">clevs_rel</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span><span class="o">*</span><span class="mi">4</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span><span class="n">fmt_abs</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="n">fmt_rel</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span><span class="o">*</span><span class="mi">4</span>

    <span class="c1"># TBD: Try to find appropriate formatting for color bar</span>
    <span class="c1"># cb_fmt_abs = [str(f)[::-1].find(&#39;.&#39;) for f in clevs_abs]</span>
    <span class="c1"># cb_fmt_rel = [str(f)[::-1].find(&#39;.&#39;) for f in clevs_rel]</span>

    <span class="n">rpl</span><span class="o">.</span><span class="n">figure_init</span><span class="p">(</span><span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">)</span>

    <span class="c1"># Create map object and axes grid</span>
    <span class="n">map_proj</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">define_map_object</span><span class="p">(</span><span class="n">map_projection</span><span class="p">,</span> <span class="o">**</span><span class="n">map_config</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs_grid</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">map_setup</span><span class="p">(</span>
        <span class="n">map_proj</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">figshape</span><span class="p">,</span> <span class="n">grid_lines</span><span class="o">=</span><span class="n">map_gridlines</span><span class="p">,</span>
        <span class="o">**</span><span class="n">map_axes_conf</span><span class="p">)</span>

    <span class="n">lts</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">]</span>
    <span class="n">lns</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">]</span>

    <span class="c1"># Plot the maps</span>
    <span class="n">mp</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">make_map_plot</span><span class="p">(</span>
        <span class="n">dlist</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">lts</span><span class="p">,</span> <span class="n">lns</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">clevs</span><span class="o">=</span><span class="n">clevs</span><span class="p">,</span> <span class="o">**</span><span class="n">map_plot_conf</span><span class="p">)</span>
    <span class="n">rpl</span><span class="o">.</span><span class="n">image_colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>

    <span class="c1"># Add contour plot if mslp</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;psl&#39;</span><span class="p">:</span>
        <span class="n">rpl</span><span class="o">.</span><span class="n">make_map_plot</span><span class="p">(</span><span class="n">dlist</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">lts</span><span class="p">,</span> <span class="n">lns</span><span class="p">,</span>  <span class="n">clevs</span><span class="o">=</span><span class="n">clevs</span><span class="p">,</span>
                          <span class="n">filled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;#4f5254&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.3</span><span class="p">)</span>

    <span class="c1"># Map settings</span>
    <span class="n">rpl</span><span class="o">.</span><span class="n">map_axes_settings</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">headtitle</span><span class="o">=</span><span class="n">headtitle</span><span class="p">,</span>
                          <span class="n">time_mean</span><span class="o">=</span><span class="s1">&#39;season&#39;</span><span class="p">)</span>

    <span class="c1"># Annotate</span>
    <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">ft</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
             <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
     <span class="k">for</span> <span class="n">ft</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ftitles</span><span class="p">,</span> <span class="p">[</span><span class="n">axs_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">*</span><span class="mi">4</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndata</span><span class="o">+</span><span class="mi">1</span><span class="p">)]])]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="map_ann_cycle">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.map_ann_cycle">[docs]</a>
<span class="k">def</span> <span class="nf">map_ann_cycle</span><span class="p">(</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">,</span> <span class="n">fm_listr</span><span class="p">,</span> <span class="n">fo_listr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span>
                  <span class="n">ref_model</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span>
                  <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span> <span class="n">grid_coords</span><span class="p">,</span> <span class="n">moments_plot_conf</span><span class="p">,</span> <span class="n">map_domain</span><span class="p">,</span>
                  <span class="n">map_projection</span><span class="p">,</span> <span class="n">map_config</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span> <span class="n">map_gridlines</span><span class="p">,</span>
                  <span class="n">map_axes_conf</span><span class="p">,</span> <span class="n">map_plot_conf</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">,</span> <span class="n">line_sets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting annual cycle map plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ref_mnme</span> <span class="o">=</span> <span class="n">ref_model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">othr_mod</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">othr_mod</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_model</span><span class="p">)</span>

    <span class="c1"># Obs data list</span>
    <span class="n">obslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">obs</span>

    <span class="c1"># Map settings</span>
    <span class="n">target_grid_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">tgname</span> <span class="o">=</span> <span class="n">target_grid_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">domain_model</span> <span class="o">=</span> <span class="n">map_domain</span> <span class="k">if</span> <span class="n">map_domain</span> <span class="k">else</span> <span class="n">ref_model</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;meta data&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="n">domain_model</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_region</span><span class="p">(</span>
        <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">],</span>
        <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">],</span> <span class="n">domain</span><span class="p">)</span>

    <span class="c1"># Data</span>
    <span class="n">fmod</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">)}</span>
    <span class="n">fmod_msk</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">_mask_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">fmod</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">if</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ref_obs</span> <span class="o">=</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obslist</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">)}</span>
        <span class="n">fobs_msk</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">_mask_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">fobs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)]]</span> <span class="o">+</span>\
                <span class="p">[[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                  <span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)]</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dlist</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">fobs_msk</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                       <span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
                <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">data_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2">&quot;</span>
                                      <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span>
            <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
                <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
            <span class="n">data_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)]]</span> <span class="o">+</span>\
                <span class="p">[[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                 <span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)]</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span>
        <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_mnme</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
            <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_mnme</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span>
        <span class="n">data_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref_mnme</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ref_mnme</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span>

    <span class="n">tsuffix_ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">time_suffix_dd</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">tsuffix_ll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">tsuffix_fname</span> <span class="o">=</span> <span class="s2">&quot;_vs_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tsuffix_ll</span><span class="p">))</span>
    <span class="n">thr</span> <span class="o">=</span> <span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
        <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># figure settings</span>
    <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">figshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;pr&#39;</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">YlGnBu</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">BrBG</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral_r</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu_r</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>

    <span class="n">clevs_abs</span> <span class="o">=</span> <span class="n">get_clevs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">centered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">clevs_rel</span> <span class="o">=</span> <span class="n">get_clevs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fmt_abs</span> <span class="o">=</span> <span class="n">_get_colorbar_label_formatting</span><span class="p">(</span><span class="n">clevs_abs</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">fmt_rel</span> <span class="o">=</span> <span class="n">_get_colorbar_label_formatting</span><span class="p">(</span><span class="n">clevs_rel</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">clevs</span> <span class="o">=</span> <span class="p">[</span><span class="n">clevs_abs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">clevs_rel</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span><span class="n">fmt_abs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">fmt_rel</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>

    <span class="n">lts</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">]</span>
    <span class="n">lns</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">]</span>

    <span class="c1"># Loop over data sets</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">data_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ndata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">data_names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">thr</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">] | Threshold: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ftitles</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">thr</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}{}</span><span class="s1">_map_ann_cycle_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ftitles</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">_map_ann_cycle_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>

        <span class="n">rpl</span><span class="o">.</span><span class="n">figure_init</span><span class="p">(</span><span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">)</span>

        <span class="c1"># Create map object and axes grid</span>
        <span class="n">map_proj</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">define_map_object</span><span class="p">(</span><span class="n">map_projection</span><span class="p">,</span> <span class="o">**</span><span class="n">map_config</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs_grid</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">map_setup</span><span class="p">(</span>
            <span class="n">map_proj</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">figshape</span><span class="p">,</span> <span class="n">grid_lines</span><span class="o">=</span><span class="n">map_gridlines</span><span class="p">,</span>
            <span class="o">**</span><span class="n">map_axes_conf</span><span class="p">)</span>

        <span class="c1"># Plot the maps</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">make_map_plot</span><span class="p">(</span>
            <span class="n">dlist</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">lts</span><span class="p">,</span> <span class="n">lns</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">clevs</span><span class="o">=</span><span class="n">clevs</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>
            <span class="o">**</span><span class="n">map_plot_conf</span><span class="p">)</span>
        <span class="n">rpl</span><span class="o">.</span><span class="n">image_colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="n">fmt</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>

        <span class="c1"># Add contour plot if mslp</span>
        <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;psl&#39;</span><span class="p">:</span>
            <span class="n">rpl</span><span class="o">.</span><span class="n">make_map_plot</span><span class="p">(</span>
                <span class="n">dlist</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">lts</span><span class="p">,</span> <span class="n">lns</span><span class="p">,</span> <span class="n">clevs</span><span class="o">=</span><span class="n">clevs</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">filled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;#4f5254&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.3</span><span class="p">)</span>
        <span class="c1"># [plt.clabel(mm, fmt=&#39;%.1f&#39;, colors=&#39;k&#39;, fontsize=15) for mm in lp]</span>

        <span class="c1"># Map settings</span>
        <span class="n">rpl</span><span class="o">.</span><span class="n">map_axes_settings</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">,</span>
                              <span class="n">headtitle</span><span class="o">=</span><span class="n">headtitle</span><span class="p">,</span> <span class="n">time_mean</span><span class="o">=</span><span class="s1">&#39;month&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="c1"># Line plot annual cycle</span>
    <span class="k">if</span> <span class="n">fm_listr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">line_ann_cycle</span><span class="p">(</span><span class="n">fm_listr</span><span class="p">,</span> <span class="n">fo_listr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span>
                       <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span>
                       <span class="n">line_grid</span><span class="p">,</span> <span class="n">line_sets</span><span class="p">)</span></div>



<div class="viewcode-block" id="line_ann_cycle">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.line_ann_cycle">[docs]</a>
<span class="k">def</span> <span class="nf">line_ann_cycle</span><span class="p">(</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span>
                   <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">,</span>
                   <span class="n">line_sets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting annual cycle line plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ref_mnme</span> <span class="o">=</span> <span class="n">ref_model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">othr_mod</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">othr_mod</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_model</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>

        <span class="n">fmod</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">[</span><span class="n">reg</span><span class="p">])}</span>
        <span class="n">mod_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fmod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">obs</span>
            <span class="n">ref_obs</span> <span class="o">=</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">obslbl</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">)</span>
            <span class="n">fobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obslist</span><span class="p">,</span>
                                                          <span class="n">fo_list</span><span class="p">[</span><span class="n">reg</span><span class="p">])}</span>
            <span class="n">obs_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fobs</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">}</span>
            <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="n">dlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="n">ll_nms</span> <span class="o">=</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ll_nms</span> <span class="o">=</span> <span class="n">models</span>
            <span class="n">lg_lbls</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ll_nms</span><span class="p">],</span>
                       <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">ref_obs</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ll_nms</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">mod_data</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]]</span>
            <span class="n">lg_lbls</span> <span class="o">=</span> <span class="p">[[</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">ref_mnme</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]]</span>

        <span class="n">tsuffix_ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">time_suffix_dd</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">tsuffix_ll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">tsuffix_fname</span> <span class="o">=</span> <span class="s2">&quot;_vs_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tsuffix_ll</span><span class="p">))</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
            <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">regnm</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">thr</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> | Threshold: </span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}{}</span><span class="s1">_lnplot_ann_cycle_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span>
                           <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}{}</span><span class="s1">_lnplot_ann_cycle_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">_lnplot_ann_cycle_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">_lnplot_ann_cycle_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>

        <span class="c1"># figure settings</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">figshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">ylabel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Monthly mean (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">),</span>
                  <span class="s1">&#39;Difference (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">)]</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">11.5</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">xticks</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">xtlbls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span> <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>

        <span class="n">rpl</span><span class="o">.</span><span class="n">figure_init</span><span class="p">(</span><span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">lgrid</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">fig_grid_setup</span><span class="p">(</span><span class="n">fshape</span><span class="o">=</span><span class="n">figshape</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">line_grid</span><span class="p">)</span>

        <span class="n">axs</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">make_line_plot</span><span class="p">(</span><span class="n">lgrid</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">dlist</span><span class="p">,</span> <span class="o">**</span><span class="n">line_sets</span><span class="p">)</span>

        <span class="p">[</span><span class="n">ln</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_lines</span><span class="p">(),</span> <span class="n">abs_colors</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">ln</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_lines</span><span class="p">())[:</span><span class="nb">len</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">rel_colors</span><span class="p">)]</span>
        <span class="c1"># Legend</span>
        <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abs_colors</span><span class="p">,</span> <span class="n">lg_lbls</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
        <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rel_colors</span><span class="p">,</span> <span class="n">lg_lbls</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>

        <span class="p">[</span><span class="n">rpl</span><span class="o">.</span><span class="n">axes_settings</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span>
                           <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">xtlabels</span><span class="o">=</span><span class="n">xtlbls</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">)]</span>

        <span class="n">ttl</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">headtitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;xx-large&#39;</span><span class="p">)</span>
        <span class="n">ttl</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">1.08</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="map_pctls">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.map_pctls">[docs]</a>
<span class="k">def</span> <span class="nf">map_pctls</span><span class="p">(</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">,</span> <span class="n">fm_listr</span><span class="p">,</span> <span class="n">fo_listr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span>
              <span class="n">obs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span>
              <span class="n">grid_coords</span><span class="p">,</span> <span class="n">moments_plot_conf</span><span class="p">,</span> <span class="n">map_domain</span><span class="p">,</span> <span class="n">map_projection</span><span class="p">,</span>
              <span class="n">map_config</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span> <span class="n">map_gridlines</span><span class="p">,</span> <span class="n">map_axes_conf</span><span class="p">,</span>
              <span class="n">map_plot_conf</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">,</span> <span class="n">line_sets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting percentile map plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ref_mnme</span> <span class="o">=</span> <span class="n">ref_model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">othr_mod</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">othr_mod</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_model</span><span class="p">)</span>

    <span class="c1"># Obs data list</span>
    <span class="n">obslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">obs</span>

    <span class="c1"># Map settings</span>
    <span class="n">target_grid_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">tgname</span> <span class="o">=</span> <span class="n">target_grid_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">domain_model</span> <span class="o">=</span> <span class="n">map_domain</span> <span class="k">if</span> <span class="n">map_domain</span> <span class="k">else</span> <span class="n">ref_model</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;meta data&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="n">domain_model</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_region</span><span class="p">(</span>
        <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">],</span>
        <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">],</span> <span class="n">domain</span><span class="p">)</span>

    <span class="c1"># Data</span>
    <span class="n">fmod</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">)}</span>
    <span class="n">fmod_msk</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">_mask_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">fmod</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="n">pctls</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">percentiles</span><span class="o">.</span><span class="n">values</span>
    <span class="n">npctl</span> <span class="o">=</span> <span class="n">pctls</span><span class="o">.</span><span class="n">size</span>
    <span class="k">if</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obslbl</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">)</span>
        <span class="n">ref_obs</span> <span class="o">=</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obslist</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">)}</span>
        <span class="n">fobs_msk</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">_mask_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">fobs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]]</span> <span class="o">+</span>
                 <span class="p">[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                  <span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                  <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npctl</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npctl</span><span class="p">):</span>
                <span class="n">dlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fobs_msk</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                             <span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                             <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
                <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span>
            <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
                <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]]</span> <span class="o">+</span>
                 <span class="p">[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                  <span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                  <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npctl</span><span class="p">)]</span>
        <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_mnme</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
            <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_mnme</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span>

    <span class="n">tsuffix_ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">time_suffix_dd</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">tsuffix_ll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">tsuffix_fname</span> <span class="o">=</span> <span class="s2">&quot;_vs_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tsuffix_ll</span><span class="p">))</span>
    <span class="n">thr</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
        <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># season = fmod[ref_model].attrs[&#39;Analysed time&#39;].split(&#39; &#39;)[1]</span>
    <span class="c1"># seas = season.replace(&#39; &#39;, &#39;&#39;)</span>

    <span class="c1"># figure settings</span>
    <span class="k">if</span> <span class="n">ndata</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">figshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndata</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;pr&#39;</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">YlGnBu</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">BrBG</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral_r</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu_r</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>

    <span class="n">lts</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">]</span>
    <span class="n">lns</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">]</span>

    <span class="c1"># Loop over percentiles</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npctl</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">thr</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span>\
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">] | p</span><span class="si">{}</span><span class="s1"> | Threshold: </span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">pctls</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}</span><span class="s1">_map_percentile_p</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">pctls</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">obslbl</span><span class="p">,</span>
                           <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}</span><span class="s1">_map_percentile_p</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">pctls</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">] | p</span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">pctls</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>
                                                    <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_map_percentile_p</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">pctls</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_map_percentile_p</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">pctls</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">tsuffix_fname</span><span class="p">)</span>

        <span class="n">rpl</span><span class="o">.</span><span class="n">figure_init</span><span class="p">(</span><span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">)</span>

        <span class="c1"># Create map object and axes grid</span>
        <span class="n">map_proj</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">define_map_object</span><span class="p">(</span><span class="n">map_projection</span><span class="p">,</span> <span class="o">**</span><span class="n">map_config</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs_grid</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">map_setup</span><span class="p">(</span>
            <span class="n">map_proj</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">figshape</span><span class="p">,</span> <span class="n">grid_lines</span><span class="o">=</span><span class="n">map_gridlines</span><span class="p">,</span>
            <span class="o">**</span><span class="n">map_axes_conf</span><span class="p">)</span>

        <span class="n">clevs_abs</span> <span class="o">=</span> <span class="n">get_clevs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">centered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">clevs_rel</span> <span class="o">=</span> <span class="n">get_clevs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fmt_abs</span> <span class="o">=</span> <span class="n">_get_colorbar_label_formatting</span><span class="p">(</span><span class="n">clevs_abs</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">fmt_rel</span> <span class="o">=</span> <span class="n">_get_colorbar_label_formatting</span><span class="p">(</span><span class="n">clevs_rel</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">clevs</span> <span class="o">=</span> <span class="p">[</span><span class="n">clevs_abs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">clevs_rel</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span><span class="n">fmt_abs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">fmt_rel</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>

        <span class="c1"># Plot the maps</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">make_map_plot</span><span class="p">(</span>
            <span class="n">dlist</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">lts</span><span class="p">,</span> <span class="n">lns</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">clevs</span><span class="o">=</span><span class="n">clevs</span><span class="p">,</span>
            <span class="o">**</span><span class="n">map_plot_conf</span><span class="p">)</span>
        <span class="n">rpl</span><span class="o">.</span><span class="n">image_colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>

        <span class="c1"># Map settings</span>
        <span class="n">rpl</span><span class="o">.</span><span class="n">map_axes_settings</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">headtitle</span><span class="o">=</span><span class="n">headtitle</span><span class="p">)</span>

        <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.03</span><span class="p">,</span> <span class="n">ft</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">,</span>
                 <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">ft</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ftitles</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">)]</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="map_diurnal_cycle">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.map_diurnal_cycle">[docs]</a>
<span class="k">def</span> <span class="nf">map_diurnal_cycle</span><span class="p">(</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">,</span> <span class="n">fm_listr</span><span class="p">,</span> <span class="n">fo_listr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span>
                      <span class="n">ref_model</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span>
                      <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span> <span class="n">grid_coords</span><span class="p">,</span> <span class="n">moments_plot_conf</span><span class="p">,</span>
                      <span class="n">map_domain</span><span class="p">,</span> <span class="n">map_projection</span><span class="p">,</span> <span class="n">map_config</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span>
                      <span class="n">map_gridlines</span><span class="p">,</span> <span class="n">map_axes_conf</span><span class="p">,</span> <span class="n">map_plot_conf</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">,</span>
                      <span class="n">line_sets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting diurnal cycle map plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ref_mnme</span> <span class="o">=</span> <span class="n">ref_model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">othr_mod</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">othr_mod</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_model</span><span class="p">)</span>

    <span class="c1"># Obs data list</span>
    <span class="n">obslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">obs</span>

    <span class="c1"># Map settings</span>
    <span class="n">target_grid_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">tgname</span> <span class="o">=</span> <span class="n">target_grid_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">domain_model</span> <span class="o">=</span> <span class="n">map_domain</span> <span class="k">if</span> <span class="n">map_domain</span> <span class="k">else</span> <span class="n">ref_model</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;meta data&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="n">domain_model</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_region</span><span class="p">(</span>
        <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">],</span>
        <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">],</span> <span class="n">domain</span><span class="p">)</span>

    <span class="c1"># Data</span>
    <span class="n">fmod</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">)}</span>
    <span class="n">fmod_msk</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">_mask_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">fmod</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="n">hours</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span>
    <span class="n">nhour</span> <span class="o">=</span> <span class="n">hours</span><span class="o">.</span><span class="n">size</span>
    <span class="n">fshape</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nhour</span><span class="p">)</span> <span class="k">if</span> <span class="n">nhour</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="k">else</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nhour</span><span class="o">/</span><span class="mi">2</span><span class="p">)))</span>
              <span class="k">if</span> <span class="mi">6</span> <span class="o">&lt;</span> <span class="n">nhour</span> <span class="o">&lt;=</span> <span class="mi">12</span> <span class="k">else</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nhour</span><span class="o">/</span><span class="mi">3</span><span class="p">)))</span>
              <span class="k">if</span> <span class="mi">12</span> <span class="o">&lt;</span> <span class="n">nhour</span> <span class="o">&lt;=</span> <span class="mi">18</span> <span class="k">else</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nhour</span><span class="o">/</span><span class="mi">4</span><span class="p">))))</span>

    <span class="k">if</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ref_obs</span> <span class="o">=</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obslist</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">)}</span>
        <span class="n">fobs_msk</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">_mask_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">fobs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nhour</span><span class="p">)]]</span>\
            <span class="o">+</span> <span class="p">[[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                <span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nhour</span><span class="p">)]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dlist</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">fobs_msk</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                       <span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nhour</span><span class="p">)]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
                <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">data_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2">&quot;</span>
                                      <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span>
            <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
                <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
            <span class="n">data_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nhour</span><span class="p">)]]</span> <span class="o">+</span>\
                <span class="p">[[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                  <span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nhour</span><span class="p">)]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span>
        <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref_mnme</span><span class="p">]</span> <span class="o">+</span> <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_mnme</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span>
        <span class="n">data_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref_mnme</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ref_mnme</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span>

    <span class="n">dcycle_stat</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
        <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dcycle_stat</span> <span class="o">==</span> <span class="s1">&#39;Amount&#39;</span><span class="p">:</span>
        <span class="n">dc_units</span> <span class="o">=</span> <span class="n">units</span>
        <span class="n">fn_prfx</span> <span class="o">=</span> <span class="s1">&#39;amnt&#39;</span>
    <span class="k">elif</span> <span class="n">dcycle_stat</span> <span class="o">==</span> <span class="s1">&#39;Frequency&#39;</span><span class="p">:</span>
        <span class="n">dc_units</span> <span class="o">=</span> <span class="s1">&#39;frequency&#39;</span>
        <span class="n">fn_prfx</span> <span class="o">=</span> <span class="s1">&#39;freq&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Unknown diurnal cycle statistic, exiting...&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="n">tsuffix_ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">time_suffix_dd</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">tsuffix_ll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">tsuffix_fname</span> <span class="o">=</span> <span class="s2">&quot;_vs_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tsuffix_ll</span><span class="p">))</span>
    <span class="n">thr</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
        <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># season = fmod[ref_model].attrs[&#39;Analysed time&#39;].split(&#39; &#39;)[1]</span>
    <span class="c1"># seas = season.replace(&#39; &#39;, &#39;&#39;)</span>

    <span class="c1"># figure settings</span>
    <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
    <span class="n">figshape</span> <span class="o">=</span> <span class="n">fshape</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;pr&#39;</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">YlGnBu</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">BrBG</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral_r</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu_r</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>

    <span class="n">clevs_abs</span> <span class="o">=</span> <span class="n">get_clevs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">centered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">clevs_rel</span> <span class="o">=</span> <span class="n">get_clevs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fmt_abs</span> <span class="o">=</span> <span class="n">_get_colorbar_label_formatting</span><span class="p">(</span><span class="n">clevs_abs</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">fmt_rel</span> <span class="o">=</span> <span class="n">_get_colorbar_label_formatting</span><span class="p">(</span><span class="n">clevs_rel</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">clevs</span> <span class="o">=</span> <span class="p">[</span><span class="n">clevs_abs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">clevs_rel</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span><span class="n">fmt_abs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">fmt_rel</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>

    <span class="n">lts</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">]</span>
    <span class="n">lns</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">]</span>

    <span class="c1"># Loop over data sets</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">data_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ndata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">data_names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">thr</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">] | Threshold: </span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ftitles</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">var</span><span class="p">,</span> <span class="n">dc_units</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}{}</span><span class="s1">_map_diurnal_cycle_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">fn_prfx</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">] | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ftitles</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">var</span><span class="p">,</span> <span class="n">dc_units</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">_map_diurnal_cycle_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">fn_prfx</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>

        <span class="n">rpl</span><span class="o">.</span><span class="n">figure_init</span><span class="p">(</span><span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">)</span>

        <span class="c1"># Create map object and axes grid</span>
        <span class="n">map_proj</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">define_map_object</span><span class="p">(</span><span class="n">map_projection</span><span class="p">,</span> <span class="o">**</span><span class="n">map_config</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs_grid</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">map_setup</span><span class="p">(</span>
            <span class="n">map_proj</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">figshape</span><span class="p">,</span> <span class="n">grid_lines</span><span class="o">=</span><span class="n">map_gridlines</span><span class="p">,</span>
            <span class="o">**</span><span class="n">map_axes_conf</span><span class="p">)</span>

        <span class="c1"># Plot the maps</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">make_map_plot</span><span class="p">(</span>
            <span class="n">dlist</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">lts</span><span class="p">,</span> <span class="n">lns</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">clevs</span><span class="o">=</span><span class="n">clevs</span><span class="p">[</span><span class="n">p</span><span class="p">],</span>
            <span class="o">**</span><span class="n">map_plot_conf</span><span class="p">)</span>
        <span class="n">rpl</span><span class="o">.</span><span class="n">image_colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="n">fmt</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>

        <span class="c1"># Map settings</span>
        <span class="n">rpl</span><span class="o">.</span><span class="n">map_axes_settings</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">headtitle</span><span class="o">=</span><span class="n">headtitle</span><span class="p">,</span>
                              <span class="n">time_mean</span><span class="o">=</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="n">time_units</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="c1"># Line plot diurnal cycle</span>
    <span class="k">if</span> <span class="n">fm_listr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">line_diurnal_cycle</span><span class="p">(</span><span class="n">fm_listr</span><span class="p">,</span> <span class="n">fo_listr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span>
                           <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">dc_units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span>
                           <span class="n">img_dir</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">,</span> <span class="n">line_sets</span><span class="p">)</span></div>



<div class="viewcode-block" id="line_diurnal_cycle">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.line_diurnal_cycle">[docs]</a>
<span class="k">def</span> <span class="nf">line_diurnal_cycle</span><span class="p">(</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span>
                       <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span>
                       <span class="n">line_grid</span><span class="p">,</span> <span class="n">line_sets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting annual cycle line plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ref_mnme</span> <span class="o">=</span> <span class="n">ref_model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">othr_mod</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">othr_mod</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_model</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>

        <span class="n">fmod</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">[</span><span class="n">reg</span><span class="p">])}</span>
        <span class="n">mod_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fmod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">}</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">obs</span>
            <span class="n">ref_obs</span> <span class="o">=</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">obslbl</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">)</span>
            <span class="n">fobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obslist</span><span class="p">,</span>
                                                          <span class="n">fo_list</span><span class="p">[</span><span class="n">reg</span><span class="p">])}</span>
            <span class="n">obs_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fobs</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">}</span>
            <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="n">dlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="n">ll_nms</span> <span class="o">=</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ll_nms</span> <span class="o">=</span> <span class="n">models</span>
            <span class="n">lg_lbls</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ll_nms</span><span class="p">],</span>
                       <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">ref_obs</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ll_nms</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">mod_data</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]]</span>
            <span class="n">lg_lbls</span> <span class="o">=</span> <span class="p">[[</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">ref_mnme</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]]</span>

        <span class="n">xdata</span> <span class="o">=</span> <span class="p">[[</span><span class="n">hours</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">[</span><span class="n">hours</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="n">dcycle_stat</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
            <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dcycle_stat</span> <span class="o">==</span> <span class="s1">&#39;Amount&#39;</span><span class="p">:</span>
            <span class="n">fn_prfx</span> <span class="o">=</span> <span class="s1">&#39;amnt&#39;</span>
        <span class="k">elif</span> <span class="n">dcycle_stat</span> <span class="o">==</span> <span class="s1">&#39;Frequency&#39;</span><span class="p">:</span>
            <span class="n">fn_prfx</span> <span class="o">=</span> <span class="s1">&#39;freq&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Unknown diurnal cycle statistic, exiting...&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">tsuffix_ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">time_suffix_dd</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">tsuffix_ll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">tsuffix_fname</span> <span class="o">=</span> <span class="s2">&quot;_vs_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tsuffix_ll</span><span class="p">))</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
            <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># season = fmod[ref_model].attrs[&#39;Analysed time&#39;].split(&#39; &#39;)[1]</span>
        <span class="c1"># seas = season.replace(&#39; &#39;, &#39;&#39;)</span>
        <span class="n">regnm</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">thr</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">) |  Threshold: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">dcycle_stat</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_thr</span><span class="si">{}{}{}</span><span class="s2">_lnplot_diurnal_cycle_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_model_&quot;</span>
                      <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.png&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                          <span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">fn_prfx</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span>
                          <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_thr</span><span class="si">{}{}{}</span><span class="s2">_lnplot_diurnal_cycle_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_model_&quot;</span>
                      <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.png&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">fn_prfx</span><span class="p">,</span>
                                       <span class="n">regnm</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">dcycle_stat</span><span class="p">,</span>
                                                    <span class="n">reg</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">_lnplot_diurnal_cycle_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">fn_prfx</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span>
                           <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1">_lnplot_diurnal_cycle_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">fn_prfx</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>

        <span class="c1"># figure settings</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">figshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ylabel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">),</span> <span class="s1">&#39;Difference (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">)]</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Hour (UTC)&#39;</span><span class="p">]</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="n">hours</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">.5</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">xticks</span> <span class="o">=</span> <span class="n">hours</span><span class="p">[:]</span>
        <span class="n">xtlbls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{:02d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hours</span><span class="p">]</span>

        <span class="n">rpl</span><span class="o">.</span><span class="n">figure_init</span><span class="p">(</span><span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">lgrid</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">fig_grid_setup</span><span class="p">(</span><span class="n">fshape</span><span class="o">=</span><span class="n">figshape</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">line_grid</span><span class="p">)</span>

        <span class="c1"># Scatter</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">make_scatter_plot</span><span class="p">(</span><span class="n">lgrid</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">dlist</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                    <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="p">[</span><span class="n">pts</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">pts</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">collections</span><span class="p">,</span> <span class="n">abs_colors</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">pts</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">pts</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">collections</span><span class="p">,</span> <span class="n">rel_colors</span><span class="p">)]</span>
        <span class="c1"># Legend</span>
        <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abs_colors</span><span class="p">,</span> <span class="n">lg_lbls</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
        <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rel_colors</span><span class="p">,</span> <span class="n">lg_lbls</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>

        <span class="p">[</span><span class="n">rpl</span><span class="o">.</span><span class="n">axes_settings</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span>
                           <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">xtlabels</span><span class="o">=</span><span class="n">xtlbls</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">)]</span>

        <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">]</span>

        <span class="n">ttl</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">headtitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;xx-large&#39;</span><span class="p">)</span>
        <span class="n">ttl</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">1.06</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="moments_plot">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.moments_plot">[docs]</a>
<span class="k">def</span> <span class="nf">moments_plot</span><span class="p">(</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">,</span> <span class="n">fm_listr</span><span class="p">,</span> <span class="n">fo_listr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span>
                 <span class="n">ref_model</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span>
                 <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span> <span class="n">grid_coords</span><span class="p">,</span> <span class="n">moments_plot_conf</span><span class="p">,</span> <span class="n">map_domain</span><span class="p">,</span>
                 <span class="n">map_projection</span><span class="p">,</span> <span class="n">map_config</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span> <span class="n">map_gridlines</span><span class="p">,</span>
                 <span class="n">map_axes_conf</span><span class="p">,</span> <span class="n">map_plot_conf</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">,</span> <span class="n">line_sets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting higher-order moment statistics</span>

<span class="sd">    Multiple plot types are available, e.g. timeseries and map plot.</span>
<span class="sd">    The type shall be specified in the main RCAT configuration file (under the</span>
<span class="sd">    &#39;plotting&#39; section). Default is timeseries.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">type_of_plot</span> <span class="o">=</span> <span class="n">moments_plot_conf</span><span class="p">[</span><span class="s1">&#39;plot type&#39;</span><span class="p">]</span>

    <span class="n">ref_mnme</span> <span class="o">=</span> <span class="n">ref_model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">othr_mod</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">othr_mod</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_model</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">type_of_plot</span> <span class="o">==</span> <span class="s1">&#39;timeseries&#39;</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>

            <span class="n">fmod</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fm_listr</span><span class="p">[</span><span class="n">reg</span><span class="p">])}</span>
            <span class="n">mod_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fmod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">}</span>

            <span class="n">err_len_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n\n\t</span><span class="s2">*** Input data arrays for timeseries plot do not&quot;</span>
                <span class="s2">&quot; all have the same lengths. This is required for these&quot;</span>
                <span class="s2">&quot; plots. ***</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ts_len_md</span> <span class="o">=</span> <span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">mod_data</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ts_len_md</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">err_len_msg</span>

            <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">obslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">obs</span>
                <span class="n">ref_obs</span> <span class="o">=</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">obslbl</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">)</span>
                <span class="n">fobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obslist</span><span class="p">,</span>
                                                              <span class="n">fo_listr</span><span class="p">[</span><span class="n">reg</span><span class="p">])}</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fobs</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">}</span>

                <span class="n">ts_len_all</span> <span class="o">=</span> <span class="n">ts_len_md</span> <span class="o">+</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ts_len_all</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">err_len_msg</span>

                <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                    <span class="n">dlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span>
                                 <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                    <span class="n">ll_nms</span> <span class="o">=</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ll_nms</span> <span class="o">=</span> <span class="n">models</span>
                <span class="n">lg_lbls</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ll_nms</span><span class="p">],</span>
                           <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ll_nms</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">mod_data</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]]</span>
                <span class="n">lg_lbls</span> <span class="o">=</span> <span class="p">[[</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">ref_mnme</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]]</span>

            <span class="n">tsuffix_ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">time_suffix_dd</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="n">tsuffix_ll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">tsuffix_fname</span> <span class="o">=</span> <span class="s2">&quot;_vs_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tsuffix_ll</span><span class="p">))</span>
            <span class="n">thr</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
                <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">moment_stat</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span>\
                <span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">regnm</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">thr</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> | Threshold: </span><span class="si">{}</span><span class="s1"> | Stat: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">moment_stat</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;timeseries_</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}</span><span class="s1">_stat_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                            <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">moment_stat</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span>
                                   <span class="n">tsuffix_fname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;timeseries_</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}</span><span class="s1">_stat_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                            <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">moment_stat</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span>
                                   <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> | Stat: </span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">,</span> <span class="n">moment_stat</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;timeseries_</span><span class="si">{}{}</span><span class="s1">_stat_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">moment_stat</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;timeseries_</span><span class="si">{}{}</span><span class="s1">_stat_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">moment_stat</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>

            <span class="c1"># figure settings</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">figshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">ylabel</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;Difference&#39;</span><span class="p">]</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
            <span class="n">xticks</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">xtlbls</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">rpl</span><span class="o">.</span><span class="n">figure_init</span><span class="p">(</span><span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">lgrid</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">fig_grid_setup</span><span class="p">(</span><span class="n">fshape</span><span class="o">=</span><span class="n">figshape</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                            <span class="o">**</span><span class="n">line_grid</span><span class="p">)</span>

            <span class="n">axs</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">make_line_plot</span><span class="p">(</span><span class="n">lgrid</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">dlist</span><span class="p">,</span> <span class="o">**</span><span class="n">line_sets</span><span class="p">)</span>
            <span class="p">[</span><span class="n">ln</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_lines</span><span class="p">(),</span>
                                                <span class="n">abs_colors</span><span class="p">)]</span>
            <span class="p">[</span><span class="n">ln</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_lines</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                <span class="n">rel_colors</span><span class="p">)]</span>

            <span class="c1"># Trendlines</span>
            <span class="k">if</span> <span class="n">moments_plot_conf</span><span class="p">[</span><span class="s1">&#39;trendline&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">abs_colors</span><span class="p">):</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ydata</span><span class="p">)),</span> <span class="n">ydata</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                    <span class="n">rpl</span><span class="o">.</span><span class="n">make_line_plot</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">lgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">ydata</span><span class="o">=</span><span class="n">p</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ydata</span><span class="p">))),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.6</span><span class="p">)</span>
                    <span class="n">rpl</span><span class="o">.</span><span class="n">make_line_plot</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">lgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">ydata</span><span class="o">=</span><span class="n">p</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ydata</span><span class="p">))),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="n">lc</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">lc</span><span class="p">,</span>
                        <span class="n">markevery</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Running mean</span>
            <span class="k">if</span> <span class="n">moments_plot_conf</span><span class="p">[</span><span class="s1">&#39;running mean&#39;</span><span class="p">]:</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">moments_plot_conf</span><span class="p">[</span><span class="s1">&#39;running mean&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">abs_colors</span><span class="p">):</span>
                    <span class="n">rmn</span> <span class="o">=</span> <span class="n">run_mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span>
                    <span class="n">rpl</span><span class="o">.</span><span class="n">make_line_plot</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">lgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">ydata</span><span class="o">=</span><span class="n">rmn</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.6</span><span class="p">)</span>
                    <span class="n">rpl</span><span class="o">.</span><span class="n">make_line_plot</span><span class="p">([</span><span class="n">lgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">ydata</span><span class="o">=</span><span class="n">rmn</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                                       <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="n">lc</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">lc</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Legend</span>
            <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abs_colors</span><span class="p">,</span> <span class="n">lg_lbls</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">if</span> <span class="n">moments_plot_conf</span><span class="p">[</span><span class="s1">&#39;trendline&#39;</span><span class="p">]:</span>
                <span class="n">legend_elements</span> <span class="o">=</span> <span class="n">legend_elements</span> <span class="o">+</span> <span class="p">[</span>
                    <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                           <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;lin. trend&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abs_colors</span><span class="p">,</span> <span class="n">lg_lbls</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">if</span> <span class="n">moments_plot_conf</span><span class="p">[</span><span class="s1">&#39;running mean&#39;</span><span class="p">]:</span>
                <span class="n">legend_elements</span> <span class="o">=</span> <span class="n">legend_elements</span> <span class="o">+</span> <span class="p">[</span>
                    <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                           <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.6</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;run. avg (window: </span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abs_colors</span><span class="p">,</span> <span class="n">lg_lbls</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
            <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rel_colors</span><span class="p">,</span> <span class="n">lg_lbls</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>

            <span class="p">[</span><span class="n">rpl</span><span class="o">.</span><span class="n">axes_settings</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span>
                               <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">xtlabels</span><span class="o">=</span><span class="n">xtlbls</span><span class="p">,</span>
                               <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
             <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">)]</span>

            <span class="n">ttl</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">headtitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;xx-large&#39;</span><span class="p">)</span>
            <span class="n">ttl</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">1.03</span><span class="p">))</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">type_of_plot</span> <span class="o">==</span> <span class="s1">&#39;map&#39;</span><span class="p">:</span>

        <span class="c1"># Obs data list</span>
        <span class="n">obslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">obs</span>

        <span class="c1"># Map settings</span>
        <span class="n">target_grid_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">tgname</span> <span class="o">=</span> <span class="n">target_grid_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">domain_model</span> <span class="o">=</span> <span class="n">map_domain</span> <span class="k">if</span> <span class="n">map_domain</span> <span class="k">else</span> <span class="n">ref_model</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;meta data&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="n">domain_model</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_region</span><span class="p">(</span>
            <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">],</span>
            <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">],</span> <span class="n">domain</span><span class="p">)</span>

        <span class="c1"># Data</span>
        <span class="n">fmod</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">)}</span>
        <span class="n">fmod_msk</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">_mask_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">fmod</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">fmod_msk</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">fmod_msk</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">if</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obslbl</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">)</span>
            <span class="n">ref_obs</span> <span class="o">=</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obslist</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">)}</span>
            <span class="n">fobs_msk</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">_mask_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">fobs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">fobs_msk</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">fobs_msk</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="n">dlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span> <span class="o">+</span>\
                    <span class="p">[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                     <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dlist</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fobs_msk</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
                          <span class="n">fobs_msk</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
                    <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span>
                <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
                    <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span> <span class="o">+</span>\
                    <span class="p">[</span><span class="n">fmod_msk</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">fmod_msk</span><span class="p">[</span><span class="n">ref_model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                     <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span>
            <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_mnme</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span>\
                <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_mnme</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span>

        <span class="n">tsuffix_ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">time_suffix_dd</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">tsuffix_ll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">tsuffix_fname</span> <span class="o">=</span> <span class="s2">&quot;_vs_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tsuffix_ll</span><span class="p">))</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
            <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">moment_stat</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span>\
            <span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># figure settings</span>
        <span class="k">if</span> <span class="n">ndata</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">figshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndata</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;pr&#39;</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">YlGnBu</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">BrBG</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral_r</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu_r</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>

        <span class="n">lts</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">]</span>
        <span class="n">lns</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">thr</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span>\
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">] | Stat: </span><span class="si">{}</span><span class="s1"> | Threshold: </span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">moment_stat</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}</span><span class="s1">_map_stat_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">moment_stat</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}</span><span class="s1">_map_stat_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">moment_stat</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">] | Stat: </span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">moment_stat</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_map_stat_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">moment_stat</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_map_stat_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">moment_stat</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>

        <span class="n">rpl</span><span class="o">.</span><span class="n">figure_init</span><span class="p">(</span><span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">)</span>

        <span class="c1"># Create map object and axes grid</span>
        <span class="n">map_proj</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">define_map_object</span><span class="p">(</span><span class="n">map_projection</span><span class="p">,</span> <span class="o">**</span><span class="n">map_config</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs_grid</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">map_setup</span><span class="p">(</span>
            <span class="n">map_proj</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">figshape</span><span class="p">,</span> <span class="n">grid_lines</span><span class="o">=</span><span class="n">map_gridlines</span><span class="p">,</span>
            <span class="o">**</span><span class="n">map_axes_conf</span><span class="p">)</span>

        <span class="n">clevs_abs</span> <span class="o">=</span> <span class="n">get_clevs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">centered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">clevs_rel</span> <span class="o">=</span> <span class="n">get_clevs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fmt_abs</span> <span class="o">=</span> <span class="n">_get_colorbar_label_formatting</span><span class="p">(</span><span class="n">clevs_abs</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">fmt_rel</span> <span class="o">=</span> <span class="n">_get_colorbar_label_formatting</span><span class="p">(</span><span class="n">clevs_rel</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">clevs</span> <span class="o">=</span> <span class="p">[</span><span class="n">clevs_abs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">clevs_rel</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span><span class="n">fmt_abs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">fmt_rel</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>

        <span class="c1"># Plot the maps</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">make_map_plot</span><span class="p">(</span><span class="n">dlist</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">lts</span><span class="p">,</span> <span class="n">lns</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                               <span class="n">clevs</span><span class="o">=</span><span class="n">clevs</span><span class="p">,</span> <span class="o">**</span><span class="n">map_plot_conf</span><span class="p">)</span>
        <span class="n">rpl</span><span class="o">.</span><span class="n">image_colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>

        <span class="c1"># Map settings</span>
        <span class="n">rpl</span><span class="o">.</span><span class="n">map_axes_settings</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">headtitle</span><span class="o">=</span><span class="n">headtitle</span><span class="p">)</span>

        <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.03</span><span class="p">,</span> <span class="n">ft</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">,</span>
                 <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">ft</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ftitles</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">)]</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="pdf_plot">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.pdf_plot">[docs]</a>
<span class="k">def</span> <span class="nf">pdf_plot</span><span class="p">(</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">,</span> <span class="n">fm_listr</span><span class="p">,</span> <span class="n">fo_listr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span>
             <span class="n">obs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span>
             <span class="n">grid_coords</span><span class="p">,</span> <span class="n">moments_plot_conf</span><span class="p">,</span> <span class="n">map_domain</span><span class="p">,</span> <span class="n">map_projection</span><span class="p">,</span>
             <span class="n">map_config</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span> <span class="n">map_gridlines</span><span class="p">,</span> <span class="n">map_axes_conf</span><span class="p">,</span>
             <span class="n">map_plot_conf</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">,</span> <span class="n">line_sets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting frequency-intensity-distribution plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ref_mnme</span> <span class="o">=</span> <span class="n">ref_model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">othr_mod</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">othr_mod</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_model</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>

        <span class="n">fmod</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fm_listr</span><span class="p">[</span><span class="n">reg</span><span class="p">])}</span>
        <span class="n">mod_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fmod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">}</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">bin_edges</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="n">bins</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">obs</span>
            <span class="n">ref_obs</span> <span class="o">=</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">obslbl</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">)</span>
            <span class="n">fobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obslist</span><span class="p">,</span>
                                                          <span class="n">fo_listr</span><span class="p">[</span><span class="n">reg</span><span class="p">])}</span>
            <span class="n">obs_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fobs</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">}</span>
            <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="n">dlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="n">ll_nms</span> <span class="o">=</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ll_nms</span> <span class="o">=</span> <span class="n">models</span>
            <span class="n">lg_lbls</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ll_nms</span><span class="p">],</span>
                       <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">ref_obs</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ll_nms</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">mod_data</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]]</span>
            <span class="n">lg_lbls</span> <span class="o">=</span> <span class="p">[[</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">ref_mnme</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]]</span>

        <span class="n">tsuffix_ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">time_suffix_dd</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">tsuffix_ll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">tsuffix_fname</span> <span class="o">=</span> <span class="s2">&quot;_vs_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tsuffix_ll</span><span class="p">))</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
            <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># season = fmod[ref_model].attrs[&#39;Analysed time&#39;].split(&#39; &#39;)[1]</span>
        <span class="c1"># seas = season.replace(&#39; &#39;, &#39;&#39;)</span>
        <span class="n">regnm</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">thr</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> |  Threshold: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}</span><span class="s1">_pdf_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}</span><span class="s1">_pdf_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> |  </span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_pdf_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_pdf_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>

        <span class="c1"># figure settings</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">figshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">ylabel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Frequency (%)&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Difference&#39;</span><span class="p">]</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">)]</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="n">nbins</span><span class="o">-</span><span class="mf">.5</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">xticks</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbins</span><span class="p">)[::</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">xtlbls</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[::</span><span class="mi">6</span><span class="p">]</span>

        <span class="n">rpl</span><span class="o">.</span><span class="n">figure_init</span><span class="p">(</span><span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">lgrid</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">fig_grid_setup</span><span class="p">(</span><span class="n">fshape</span><span class="o">=</span><span class="n">figshape</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">line_grid</span><span class="p">)</span>

        <span class="n">axs</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">make_line_plot</span><span class="p">(</span><span class="n">lgrid</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">dlist</span><span class="p">,</span> <span class="o">**</span><span class="n">line_sets</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;pr&#39;</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="p">[</span><span class="n">ln</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_lines</span><span class="p">(),</span> <span class="n">abs_colors</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">ln</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_lines</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                            <span class="n">rel_colors</span><span class="p">)]</span>
        <span class="c1"># Legend</span>
        <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abs_colors</span><span class="p">,</span> <span class="n">lg_lbls</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
        <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rel_colors</span><span class="p">,</span> <span class="n">lg_lbls</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>

        <span class="p">[</span><span class="n">rpl</span><span class="o">.</span><span class="n">axes_settings</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span>
                           <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">xtlabels</span><span class="o">=</span><span class="n">xtlbls</span><span class="p">,</span>
                           <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">)]</span>

        <span class="n">ttl</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">headtitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;xx-large&#39;</span><span class="p">)</span>
        <span class="n">ttl</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="map_asop">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.map_asop">[docs]</a>
<span class="k">def</span> <span class="nf">map_asop</span><span class="p">(</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">,</span> <span class="n">fm_listr</span><span class="p">,</span> <span class="n">fo_listr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span>
             <span class="n">obs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span>
             <span class="n">grid_coords</span><span class="p">,</span> <span class="n">moments_plot_conf</span><span class="p">,</span> <span class="n">map_domain</span><span class="p">,</span> <span class="n">map_projection</span><span class="p">,</span>
             <span class="n">map_config</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span> <span class="n">map_gridlines</span><span class="p">,</span> <span class="n">map_axes_conf</span><span class="p">,</span>
             <span class="n">map_plot_conf</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">,</span> <span class="n">line_sets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting ASoP FC factor map plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ref_mnme</span> <span class="o">=</span> <span class="n">ref_model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">othr_mod</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">othr_mod</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_model</span><span class="p">)</span>

    <span class="c1"># Obs data list</span>
    <span class="n">obslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">obs</span>

    <span class="c1"># Map settings</span>
    <span class="n">target_grid_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">tgname</span> <span class="o">=</span> <span class="n">target_grid_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Data</span>
    <span class="n">fmod</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">)}</span>

    <span class="k">if</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obslbl</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">)</span>
        <span class="n">ref_obs</span> <span class="o">=</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obslist</span><span class="p">,</span> <span class="n">fo_list</span><span class="p">)}</span>

        <span class="n">FCI</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">fmod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                    <span class="n">fobs</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">}</span>
        <span class="n">dlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">FCI</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dlist</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">fobs</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                        <span class="n">fobs</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span>
            <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_obs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">FCI</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">fmod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                    <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">}</span>
        <span class="n">dlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">FCI</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span>
        <span class="n">ndata</span> <span class="o">=</span> <span class="n">nmod</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">ftitles</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="se">\n</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_mnme</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_suffix_dd</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]</span>

    <span class="n">tsuffix_ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">time_suffix_dd</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">tsuffix_ll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">tsuffix_fname</span> <span class="o">=</span> <span class="s2">&quot;_vs_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tsuffix_ll</span><span class="p">))</span>
    <span class="n">thr</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
        <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># season = fmod[ref_model].attrs[&#39;Analysed time&#39;].split(&#39; &#39;)[1]</span>
    <span class="c1"># seas = season.replace(&#39; &#39;, &#39;&#39;)</span>

    <span class="c1"># figure settings</span>
    <span class="n">figshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndata</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">thr</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
        <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;ASoP FC Index | Thr: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;asop_FC_thr</span><span class="si">{}{}</span><span class="s1">_map_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                <span class="nb">format</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;asop_FC_thr</span><span class="si">{}{}</span><span class="s1">_map_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;ASoP FC Index&#39;</span>
        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;asop_FC</span><span class="si">{}</span><span class="s1">_map_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span>\
                <span class="nb">format</span><span class="p">(</span><span class="n">tres</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;asop_FC</span><span class="si">{}</span><span class="s1">_map_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tres</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>

    <span class="n">rpl</span><span class="o">.</span><span class="n">figure_init</span><span class="p">(</span><span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">)</span>

    <span class="c1"># Create map object and axes grid</span>
    <span class="n">map_proj</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">define_map_object</span><span class="p">(</span><span class="n">map_projection</span><span class="p">,</span> <span class="o">**</span><span class="n">map_config</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs_grid</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">map_setup</span><span class="p">(</span>
        <span class="n">map_proj</span><span class="p">,</span> <span class="n">map_extent</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">figshape</span><span class="p">,</span> <span class="n">grid_lines</span><span class="o">=</span><span class="n">map_gridlines</span><span class="p">,</span>
        <span class="o">**</span><span class="n">map_axes_conf</span><span class="p">)</span>

    <span class="n">lts</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">]</span>
    <span class="n">lns</span> <span class="o">=</span> <span class="n">grid_coords</span><span class="p">[</span><span class="s1">&#39;target grid&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">tgname</span><span class="p">]</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">PuRd</span><span class="p">]</span><span class="o">*</span><span class="n">ndata</span>
    <span class="n">clevs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">21</span><span class="p">)]</span><span class="o">*</span><span class="n">ndata</span>

    <span class="c1"># Plot the maps</span>
    <span class="n">mp</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">make_map_plot</span><span class="p">(</span>
        <span class="n">dlist</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">lts</span><span class="p">,</span> <span class="n">lns</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">clevs</span><span class="o">=</span><span class="n">clevs</span><span class="p">,</span> <span class="o">**</span><span class="n">map_plot_conf</span><span class="p">)</span>
    <span class="n">rpl</span><span class="o">.</span><span class="n">image_colorbar</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:.1f}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Map settings</span>
    <span class="n">rpl</span><span class="o">.</span><span class="n">map_axes_settings</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">,</span> <span class="n">headtitle</span><span class="o">=</span><span class="n">headtitle</span><span class="p">)</span>

    <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.03</span><span class="p">,</span> <span class="n">ft</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
             <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span> <span class="k">for</span> <span class="n">ft</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ftitles</span><span class="p">,</span> <span class="n">axs_grid</span><span class="p">)]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="c1"># Line plot asop</span>
    <span class="k">if</span> <span class="n">fm_listr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">line_asop</span><span class="p">(</span><span class="n">fm_listr</span><span class="p">,</span> <span class="n">fo_listr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span>
                  <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">,</span>
                  <span class="n">line_sets</span><span class="p">)</span></div>



<div class="viewcode-block" id="line_asop">
<a class="viewcode-back" href="../../../rcatool.runtime.html#rcatool.runtime.RCAT_plots.line_asop">[docs]</a>
<span class="k">def</span> <span class="nf">line_asop</span><span class="p">(</span><span class="n">fm_listr</span><span class="p">,</span> <span class="n">fo_listr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span>
              <span class="n">tstat</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">time_suffix_dd</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">,</span>
              <span class="n">line_sets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting ASoP line plot of C and FC factors</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ref_mnme</span> <span class="o">=</span> <span class="n">ref_model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">othr_mod</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">othr_mod</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref_model</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>

        <span class="n">fmod</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fm_listr</span><span class="p">[</span><span class="n">reg</span><span class="p">])}</span>
        <span class="n">mod_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fmod</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">}</span>

        <span class="n">bins</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">bin_edges</span><span class="o">.</span><span class="n">values</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">obs</span>
            <span class="n">ref_obs</span> <span class="o">=</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">obslbl</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">)</span>
            <span class="n">fobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">xa</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obslist</span><span class="p">,</span>
                                                          <span class="n">fo_listr</span><span class="p">[</span><span class="n">reg</span><span class="p">])}</span>
            <span class="n">obs_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fobs</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">}</span>
            <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="n">dlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">obs_data</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">ref_obs</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="n">ll_nms</span> <span class="o">=</span> <span class="n">models</span> <span class="o">+</span> <span class="n">obslist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ll_nms</span> <span class="o">=</span> <span class="n">models</span>
            <span class="n">lg_lbls</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ref_obs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ll_nms</span><span class="p">],</span>
                       <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">ref_obs</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ll_nms</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dlist</span> <span class="o">=</span> <span class="p">[[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">mod_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">mod_data</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]]</span>
            <span class="n">lg_lbls</span> <span class="o">=</span> <span class="p">[[</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">ref_mnme</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">othr_mod</span><span class="p">]]</span>

        <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">units</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">]</span>
        <span class="n">tsuffix_ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">time_suffix_dd</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">tsuffix_ll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">tsuffix_fname</span> <span class="o">=</span> <span class="s2">&quot;_vs_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tsuffix_ll</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ff</span><span class="p">,</span> <span class="n">fctr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">factors</span><span class="p">):</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">fctr</span> <span class="o">==</span> <span class="s1">&#39;FC&#39;</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">dlist_ff</span> <span class="o">=</span> <span class="p">[[</span><span class="n">arr</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">sc</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">sc</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">dlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="p">[[</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">[</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="n">thr</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">[</span><span class="n">ref_model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span>\
                <span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">regnm</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">thr</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;ASoP (</span><span class="si">{}</span><span class="s1">) |  Thr: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">fctr</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}</span><span class="s1">_asop_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">fctr</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_thr</span><span class="si">{}{}</span><span class="s1">_asop_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">var</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">fctr</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headtitle</span> <span class="o">=</span> <span class="s1">&#39;ASoP (</span><span class="si">{}</span><span class="s1">) |  </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">fctr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_asop_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">fctr</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">obslbl</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_asop_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">var</span><span class="p">,</span> <span class="n">tres</span><span class="p">,</span> <span class="n">fctr</span><span class="p">,</span> <span class="n">regnm</span><span class="p">,</span> <span class="n">tsuffix_fname</span><span class="p">)</span>

            <span class="c1"># figure settings</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">figshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">ylabel</span> <span class="o">=</span> <span class="p">[</span><span class="n">ylabels</span><span class="p">[</span><span class="n">ff</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Intensity (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">)]</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span>

            <span class="n">rpl</span><span class="o">.</span><span class="n">figure_init</span><span class="p">(</span><span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>
            <span class="n">ln_grid</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">line_grid</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;axes_pad&#39;</span> <span class="ow">in</span> <span class="n">ln_grid</span><span class="p">:</span>
                <span class="n">ln_grid</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;axes_pad&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;sharex&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ln_grid</span><span class="p">:</span>
                <span class="n">ln_grid</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;sharex&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">lgrid</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">fig_grid_setup</span><span class="p">(</span><span class="n">fshape</span><span class="o">=</span><span class="n">figshape</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                            <span class="o">**</span><span class="n">ln_grid</span><span class="p">)</span>

            <span class="n">axs</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">.</span><span class="n">make_line_plot</span><span class="p">(</span><span class="n">lgrid</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">dlist_ff</span><span class="p">,</span>
                                     <span class="n">axis_type</span><span class="o">=</span><span class="s1">&#39;logx&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">line_sets</span><span class="p">)</span>

            <span class="p">[</span><span class="n">ln</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_lines</span><span class="p">(),</span>
                                                <span class="n">abs_colors</span><span class="p">)]</span>
            <span class="p">[</span><span class="n">ln</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_lines</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                <span class="n">rel_colors</span><span class="p">)]</span>
            <span class="c1"># Legend</span>
            <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abs_colors</span><span class="p">,</span> <span class="n">lg_lbls</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
            <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rel_colors</span><span class="p">,</span> <span class="n">lg_lbls</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>

            <span class="p">[</span><span class="n">rpl</span><span class="o">.</span><span class="n">axes_settings</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
                               <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
             <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">)]</span>

            <span class="n">ttl</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">headtitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
            <span class="n">ttl</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">1.06</span><span class="p">))</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Petter Lind.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>